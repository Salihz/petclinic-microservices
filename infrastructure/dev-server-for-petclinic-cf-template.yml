AWSTemplateFormatVersion: 2010-09-09

Description: >
  This clouformation template prepares development environment for pet clinic microservices app
  User needs to select appropriate key name when launching the template.

Parameters:
  KeyPairName:
    Description: Enter the name of the your existing Key Pair for SSH connection
    Type: AWS::EC2::KeyPAir::KeyName
    ConstrainDescription: Must be an existing EC2 key pair  

Resources:
  PetclinicSG:
    Type: AWS::EC2:SecurityGroup
    Properties:
      GroupDescription: Enable HTTP and SSH petclinic microservices
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIP: 0.0.0.0./0
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 8888
            ToPort: 8888
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 8761
            ToPort: 8761
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 8081
            ToPort: 8081
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 8082
            ToPort: 8082
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 8083
            ToPort: 8083
            CidrIP: 0.0.0.0./0 
          - IpProtocol: tcp
            FromPort: 8080
            ToPort: 8080
            CidrIP: 0.0.0.0./0 
          - IpProtocol: tcp
            FromPort: 9411
            ToPort: 9411
            CidrIP: 0.0.0.0./0 
          - IpProtocol: tcp
            FromPort: 9090
            ToPort: 9090
            CidrIP: 0.0.0.0./0 
          - IpProtocol: tcp
            FromPort: 7979
            ToPort: 7979
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 3000
            ToPort: 3000
            CidrIP: 0.0.0.0./0  
          - IpProtocol: tcp
            FromPort: 9091
            ToPort: 9091
            CidrIP: 0.0.0.0./0  

  PetClinicLT:
    Type: AWS::EC2:LaunchTemplate
    Properties:
      LaunchTemplateData:
        ImageId: ami-0915bcb5fa77e4892
        InstanceType: t2.medium
        KeyName: !Ref KeyPairName
        SecurityGroupIds:
          - !GetAtt PetclinicSG.FroupId

        UserData:
          Fn::Base64: |
            #! /bin/bash
            yum update -y
            hostnamectl set-hostname petclinic-dev-server
            amazon-linux-extras install docker -y
            systemctl start docker
            systemctl enable docker
            usermod -a -G docker ec2-user
            curl -L "https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)" -o \ 
            /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            yum install git -y
            yum install java-11-amazon-corretto -y
            git clone https://github.com/Salihz/petclinic-microservices.git  
            cd petclinic-microservices
            git fetch
            git checkout dev  
  PetClinicServer:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref PetClinicLT
        Version: !GetAtt PetClinicLT.LatestVersionNumber
      Tags: 
        - Keys: name
          Value: !Sub Petclinic App Dev Server ${AWS::StackName}

Output:
  PetClinicDNSName:
    Description: PetClinic App Url
    Value: !GetAtt PetClinicServer.PublicDnsName